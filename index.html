<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7462519862770683"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="img/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-image: url('img/background.png');
            background-size: cover;
            color: #fff; /* 文字顏色，確保對比度 */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        header {
            background-color: #fff; /* 白色背景 */
            color: #333; /* 文字顏色 */
            padding: 20px;
            text-align: center;
            position: relative;
            padding-top: 60px; /* 增加上方間距 */
            text-align: center; /* 置中標題內容 */
            animation: fadeIn 1s ease-in-out;
        }

        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center; /* 置中導覽列 */
            align-items: center; /* 垂直置中項目 */
            animation: slideIn 1s ease-in-out;
            flex-wrap: nowrap; /* 防止換行 */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        nav ul li {
            display: inline;
            margin-right: 20px;
            white-space: nowrap; /* 防止文字換行 */
        }

        nav ul li:last-child {
            margin-right: 0; /* 移除最後一項的間距 */
        }

        nav ul li a {
            color: #ffbf00; /* 橙黃色 */
            text-decoration: none;
            font-weight: bold;
            font-size: calc(11px + 0.5vw); /* 根據螢幕大小調整字體大小 */
            user-select: none; /* 防止文字選取 */
            max-width: 100%; /* Ensure text fits within the div */
            overflow: hidden; /* Prevent text overflow */
            text-overflow: ellipsis; /* Add ellipsis for overflow text */
        }

        nav ul li a:hover,
        nav ul li a:focus {
            color: #fff; /* 滑鼠懸停時的顏色 */
        }

        .auth-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .auth-buttons a,
        .auth-buttons button {
            color: #ffbf00;
            background-color: #333;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            border: none;
            cursor: pointer;
            display: inline-block;
            font-size: calc(10px + 0.5vw);
            animation: fadeIn 1.5s ease-in-out;
        }

        .auth-buttons a:hover,
        .auth-buttons a:focus,
        .auth-buttons button:hover,
        .auth-buttons button:focus {
            color: #fff;
        }

        section {
            margin: 20px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background-color: rgba(255, 255, 255, 0.7); /* 白色背景透明度為0.7 */
            animation: fadeInUp 1s ease-in-out;
        }

        h2 {
            color: #000; /* 黑色文字 */
            animation: fadeInDown 1s ease-in-out;
        }

        .download-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .download-buttons a {
            color: #000;
            background-color: #ffbf00;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            margin: 5px;
            width: 30%; /* 確保按鈕寬度一致 */
            text-align: center;
            animation: fadeIn 1.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .tunnel-item {
            background-color: #f0f0f0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            color: #333;
        }

        .tunnel-item strong {
            color: #ffbf00;
        }

        .tunnel-item p {
            margin: 5px 0;
        }

        .tunnel-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        input {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        
        .tunnel-status-online {
            background-color: #d4edda;
            color: #155724;
        }

        .tunnel-status-offline {
            background-color: #f8d7da;
            color: #721c24;
        }

        .tunnel-status p {
            margin: 0;
        }

        .tunnel-status-online {
            color: green;
        }

        .tunnel-status-offline {
            color: red;
        }

        .no-tunnel-message {
            color: #000;
            font-size: 16px;
            margin-top: 20px;
        }

        .tunnel-table-container {
            overflow-x: auto;
        }

        .tunnel-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            min-width: 600px; /* Ensure table doesn't shrink too much */
        }

        .tunnel-table th, .tunnel-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .tunnel-table th {
            background-color: #f2f2f2;
            color: #333;
        }

        .tunnel-status-icon {
            width: 20px;
            height: 20px;
            vertical-align: middle;
            border-radius: 50%;
            display: inline-block;
        }

        .tunnel-status-online .tunnel-status-icon {
            background-color: green;
        }

        .tunnel-status-offline .tunnel-status-icon {
            background-color: red;
        }

        .promo-section {
            text-align: center;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 40px 20px;
            margin: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            animation: fadeIn 1s ease-in-out;
        }

        .promo-section h2 {
            color: #ffbf00;
            margin-bottom: 20px;
        }

        .promo-section p {
            color: #333;
            font-size: 18px;
            margin-bottom: 20px;
        }

        .promo-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .promo-buttons a {
            color: #fff;
            background-color: #ffbf00;
            padding: 15px 30px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 18px;
            font-weight: bold;
            animation: fadeIn 1.5s ease-in-out;
        }

        .promo-buttons a:hover,
        .promo-buttons a:focus {
            background-color: #e6ac00;
        }

        .message-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            z-index: 1001;
        }
        .message-box button {
            margin-top: 10px;
            padding: 10px 20px;
            background-color: #333;
            color: #ffbf00;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .server-status-online {
            color: green;
        }

        .server-status-offline {
            color: red;
        }

        .server-status-table-container {
            overflow-x: hidden; /* Prevent horizontal scroll */
            white-space: normal; /* Allow text to wrap */
        }

        .server-status-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .server-status-table td {
            color: #000; /* Make text under "伺服器名稱" black */
        }

        .server-status-table th, .server-status-table td {
            border: 1px solid #000000;
            padding: 8px;
            text-align: center;
        }

        .server-status-table th {
            background-color: #f2f2f2;
            color: #333;
        }

        .server-status-icon {
            width: 20px;
            height: 20px;
            vertical-align: middle;
            border-radius: 50%;
            display: inline-block;
        }

        .server-status-online .server-status-icon {
            background-color: green;
        }

        .server-status-offline .server-status-icon {
            background-color: red;
        }

        .discord-status {
            display: none;
            color: red;
            background-color: rgba(255, 0, 0, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .discord-status button {
            background-color: #ffbf00;
            color: #333;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: calc(10px + 0.5vw);
            margin-top: 10px;
        }

        .discord-status button:hover,
        .discord-status button:focus {
            background-color: #e6ac00;
            color: #fff;
        }

        #tunnel-list-section {
            word-wrap: break-word; /* Ensure long words break properly */
            white-space: normal; /* Allow text wrapping */
        }

        .tunnel-table-container {
            overflow-x: auto; /* Enable horizontal scrolling for smaller screens */
        }

        .tunnel-table th, .tunnel-table td {
            word-break: keep-all; /* Prevent breaking words unnecessarily */
            white-space: nowrap; /* Prevent text from wrapping prematurely */
        }

        @media (max-width: 768px) {
            .server-status-table td.server-status-online .server-status-text,
            .server-status-table td.server-status-offline .server-status-text {
                display: none !important;
            }
            .server-status-table td.server-status-online .server-status-icon {
                background-color: green;
                display: inline-block;
            }
            .server-status-table td.server-status-offline .server-status-icon {
                background-color: red;
                display: inline-block;
            }
            /* 忙碌程度顏色 */
            .server-level.level-best {
                color: #00b300 !important; /* 綠色 */
                font-weight: bold;
            }
            .server-level.level-normal {
                color: #ff9900 !important; /* 橘色 */
                font-weight: bold;
            }
            .server-level.level-busy {
                color: #ff0000 !important; /* 紅色 */
                font-weight: bold;
            }
        }

        @media (min-width: 769px) {
            .server-level.level-best {
                color: #00b300;
                font-weight: bold;
            }
            .server-level.level-normal {
                color: #ff9900;
                font-weight: bold;
            }
            .server-level.level-busy {
                color: #ff0000;
                font-weight: bold;
            }
        }

        .runid-container {
            border: 2px solid #04ff00;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: rgba(0, 255, 0, 0.1);
            font-family: 'Courier New', Courier, monospace; /* Monospace font for tree structure */
        }

        .offline-container {
            border: 2px solid #ff0000;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: rgba(255, 0, 0, 0.1);
            font-family: 'Courier New', Courier, monospace;
        }

        .runid-title, .offline-status {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .runid-title {
            color: #ffa500;
            font-weight: bold;
        }

        .offline-status {
            color: #ff0000;
            font-weight: bold;
        }

        .tree-container {
            display: flex;
            flex-direction: column;
            align-items: center; /* Center horizontally */
            justify-content: center; /* Center vertically */
            gap: 10px;
            font-size: 16px;
            line-height: 1.8;
            text-align: center; /* Ensure text alignment is centered */
        }

        .tree-node {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer; /* Add pointer cursor for clickable nodes */
        }

        .tree-branch {
            border-left: 2px solid #ccc;
            margin-left: 10px;
            padding-left: 10px;
        }

        .tree-icon {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .tree-icon.online {
            background-color: green;
        }

        .tree-icon.offline {
            background-color: red;
        }

        .tree-label {
            font-weight: bold;
        }

        .tree-protocols {
            font-size: 14px;
            color: #555;
        }

        .popup {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1002;
            display: none;
        }

        .server-status-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 16px;
            text-align: left;
            color: #000; /* Black text for better readability */
        }

        .server-status-table th, .server-status-table td {
            border: 1px solid #000000;
            padding: 8px;
        }

        .server-status-table th {
            background-color: #f2f2f2;
            color: #333; /* Darker text for headers */
            font-weight: bold;
        }

        .server-status-table tr:nth-child(even) {
            background-color: #f9f9f9; /* Light gray for even rows */
        }

        .server-status-table tr:hover {
            background-color: #f1f1f1; /* Highlight row on hover */
        }

        .server-status-container {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(120, 120, 120, 0.9); /* Slightly transparent white background */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
        }

        @media (max-width: 900px) {
            nav ul#main-nav {
                display: block;
                position: absolute;
                top: 60px;
                left: 0;
                width: 100vw;
                background: rgba(255,255,255,0.97);
                box-shadow: 0 4px 16px rgba(0,0,0,0.08);
                max-height: 0;
                pointer-events: none;
                z-index: 1500;
            }
            nav ul#main-nav.open {
                max-height: 500px;
                pointer-events: auto;
            }
            nav ul#main-nav li {
                display: block;
                text-align: center;
                margin: 18px 0;
            }
            #hamburger-menu {
                display: block !important;
            }
            nav ul#main-nav {
                display: block;
            }
        }
        @media (min-width: 901px) {
            #hamburger-menu {
                display: none !important;
                
            }
            nav ul#main-nav {
                display: flex;
                position: static;
                max-height: none !important;
                background: none;
                box-shadow: none;
                pointer-events: auto;
            }
            nav ul#main-nav li {
                display: inline-block;
                margin: 0 12px;
            }
        }

        #hamburger-menu {
            width: 48px;
            height: 48px;
            aspect-ratio: 1/1;
            border: 2px solid #000;
            border-radius: 8px;
            background: #fff;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            position: absolute;
            left: 6px;
            top: 16px;
            z-index: 2000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: border-color 0.2s;
            border: none !important; 
        }
        #hamburger-menu:focus, #hamburger-menu:hover {
            border-color: #1fb032;
        }
    </style>
    <title>TAIWANFRP - Minecraft伺服器穿透服務</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Add Chart.js library -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const username = document.cookie.split('; ').find(row => row.startsWith('username='));
            const password = document.cookie.split('; ').find(row => row.startsWith('password='));
            const isLoggedIn = username && password;
            const loginButton = document.getElementById('login-button');
            const registerButton = document.getElementById('register-button');
            const logoutButton = document.getElementById('logout-button');
            const deleteAccountButton = document.getElementById('delete-account-button');
            const editTunnelButton = document.getElementById('edit-tunnel-button');
            const tunnelListSection = document.getElementById('tunnel-list-section');
            const tunnelList = document.getElementById('tunnel-list');
            const noTunnelMessage = document.getElementById('no-tunnel-message');
            let tunnels = [];
            let nodes = [];
            let popupElement = null;

            function formatTraffic(bytes) {
                if (bytes < 1024) {
                    return `${bytes} B`; // Display in bytes
                } else if (bytes < 1024 * 1024) {
                    return `${(bytes / 1024).toFixed(2)} KB`; // Convert to KB
                } else if (bytes < 1024 * 1024 * 1024) {
                    return `${(bytes / (1024 * 1024)).toFixed(2)} MB`; // Convert to MB
                } else {
                    return `${(bytes / (1024 * 1024 * 1024)).toFixed(2)} GB`; // Convert to GB
                }
            }

            window.formatTraffic = formatTraffic;

            async function renderRunidTree() {
                if (!isLoggedIn) return;

                const usernameValue = username.split('=')[1];
                const passwordValue = password.split('=')[1];

                const response = await fetch('https://taiwanfrp.ddns.net/list_tunnels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: usernameValue, password: passwordValue })
                });

                if (!response.ok) {
                    tunnelList.innerHTML = '<p class="no-tunnel-message">當前還沒有代理，點擊右上角“編輯我的代理”建立一個</p>';
                    return;
                }

                const data = await response.json();
                const tunnels = data.tunnels;
                const runidTree = {};
                const offlineTunnels = [];

                for (const tunnel of tunnels) {
                    const protocols = ['tcp', 'udp'];
                    let isOnline = false;
                    let protocolsOnline = new Set();

                    for (const protocol of protocols) {
                        const checkResponse = await fetch('https://taiwanfrp.ddns.net/check_tunnel', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                username: usernameValue,
                                password: passwordValue,
                                tunnelName: tunnel.name,
                                protocol,
                                nodeName: tunnel.node
                            })
                        });

                        const checkData = checkResponse.ok ? await checkResponse.json() : { status: 'offline' };
                        if (checkData.status === 'online') {
                            isOnline = true;
                            protocolsOnline.add(protocol.toUpperCase());

                            const queryResponse = await fetch('https://taiwanfrp.ddns.net/query_runid', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    username: usernameValue,
                                    password: passwordValue,
                                    tunnelName: tunnel.name,
                                    protocol
                                })
                            });

                            if (queryResponse.ok) {
                                const queryData = await queryResponse.json();
                                const runid = queryData.runid;

                                if (!runidTree[runid]) {
                                    runidTree[runid] = { node: tunnel.node, proxies: {} };
                                }

                                if (!runidTree[runid].proxies[tunnel.name]) {
                                    runidTree[runid].proxies[tunnel.name] = { protocols: new Set() };
                                }

                                runidTree[runid].proxies[tunnel.name].protocols = new Set([
                                    ...runidTree[runid].proxies[tunnel.name].protocols,
                                    ...protocolsOnline
                                ]);
                            }
                        }
                    }

                    if (!isOnline) {
                        offlineTunnels.push({
                            proxyName: tunnel.name,
                            node: tunnel.node
                        });
                    }
                }

                renderTree(runidTree, offlineTunnels);
            }

            function renderTree(runidTree, offlineTunnels) {
                let treeHtml = '';

                if (Object.keys(runidTree).length === 0 && offlineTunnels.length === 0) {
                    tunnelList.innerHTML = '<p class="no-tunnel-message">當前還沒有代理</p>';
                    return;
                }

                if (Object.keys(runidTree).length > 0) {
                    treeHtml += Object.entries(runidTree)
                        .map(([runid, { node, proxies }]) => `
                            <div class="runid-container">
                                <h3 class="runid-title">在線代理客戶端ID: ${runid} <br><span style="font-weight: normal;">(節點: ${node})</span></h3>
                                <div class="tree-container">
                                    ${Object.entries(proxies).map(([proxyName, { protocols }]) => `
                                        <div class="tree-node" onclick="showProxyDetails('${proxyName}', '${node}', event)">
                                            <div class="tree-icon online"></div>
                                            <span class="tree-label">${proxyName}</span>
                                            <span class="tree-protocols">協議: ${Array.from(protocols).join('/')}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('');
                }

                if (offlineTunnels.length > 0) {
                    const groupedByNode = offlineTunnels.reduce((acc, tunnel) => {
                        acc[tunnel.node] = acc[tunnel.node] || [];
                        acc[tunnel.node].push(tunnel.proxyName);
                        return acc;
                    }, {});

                    treeHtml += Object.entries(groupedByNode)
                        .map(([node, tunnels]) => `
                            <div class="offline-container">
                                <h3 class="offline-status">離線代理 <br><span style="font-weight: normal;">(節點: ${node})</span></h3>
                                <div class="tree-container">
                                    ${tunnels.map(proxyName => `
                                        <div class="tree-node" onclick="showProxyDetails('${proxyName}', '${node}', event)">
                                            <div class="tree-icon offline"></div>
                                            <span class="tree-label">${proxyName}</span>
                                            <span class="tree-protocols">協議: 離線</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('');
                }

                tunnelList.innerHTML = treeHtml;
            }

            async function fetchTunnelData(proxyName, nodeName, protocol) {
                const username = document.cookie.split('; ').find(row => row.startsWith('username=')).split('=')[1];
                const password = document.cookie.split('; ').find(row => row.startsWith('password=')).split('=')[1];

                const response = await fetch('https://taiwanfrp.ddns.net/check_tunnel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        password,
                        tunnelName: proxyName,
                        protocol,
                        nodeName
                    })
                });

                return response.ok ? await response.json() : { status: 'offline', cur_conns: 0, last_start_time: 'N/A', today_traffic_in: 0, today_traffic_out: 0, remote_port: null };
            }

            async function fetchNodeIp(nodeName) {
                const response = await fetch('https://taiwanfrp.ddns.net/nodes.json');
                if (response.ok) {
                    const data = await response.json();
                    const node = data.nodes.find(n => n.name === nodeName);
                    return node ? node.ip : 'N/A';
                }
                return 'N/A';
            }

            window.showProxyDetails = async function(proxyName, nodeName, event) {
                const username = document.cookie.split('; ').find(row => row.startsWith('username=')).split('=')[1];
                const password = document.cookie.split('; ').find(row => row.startsWith('password=')).split('=')[1];

                // Fetch both TCP and UDP data
                const tcpData = await fetchTunnelData(proxyName, nodeName, 'tcp');
                const udpData = await fetchTunnelData(proxyName, nodeName, 'udp');

                let protocol = '';
                let statusText = '離線';
                let totalConnections = 0;
                let totalTrafficIn = 0;
                let totalTrafficOut = 0;
                let lastStartTime = 'N/A';

                // Determine protocol and aggregate data
                if (tcpData.status === 'online' && udpData.status === 'online') {
                    protocol = 'TCP/UDP';
                    statusText = '在線';
                    totalConnections = (tcpData.cur_conns || 0) + (udpData.cur_conns || 0);
                    totalTrafficIn = (tcpData.today_traffic_in || 0) + (udpData.today_traffic_in || 0);
                    totalTrafficOut = (tcpData.today_traffic_out || 0) + (udpData.today_traffic_out || 0);
                    lastStartTime = tcpData.last_start_time === udpData.last_start_time
                        ? tcpData.last_start_time || 'N/A'
                        : tcpData.last_start_time || 'N/A'; // Prefer TCP's start time if different
                } else if (tcpData.status === 'online') {
                    protocol = 'TCP';
                    statusText = '在線';
                    totalConnections = tcpData.cur_conns || 0;
                    totalTrafficIn = tcpData.today_traffic_in || 0;
                    totalTrafficOut = tcpData.today_traffic_out || 0;
                    lastStartTime = tcpData.last_start_time || 'N/A';
                } else if (udpData.status === 'online') {
                    protocol = 'UDP';
                    statusText = '在線';
                    totalConnections = udpData.cur_conns || 0;
                    totalTrafficIn = udpData.today_traffic_in || 0;
                    totalTrafficOut = udpData.today_traffic_out || 0;
                    lastStartTime = udpData.last_start_time || 'N/A';
                } else {
                    // Offline case: aggregate TCP and UDP data
                    protocol = '離線';
                    totalConnections = (tcpData.cur_conns || 0) + (udpData.cur_conns || 0);
                    totalTrafficIn = (tcpData.today_traffic_in || 0) + (udpData.today_traffic_in || 0);
                    totalTrafficOut = (tcpData.today_traffic_out || 0) + (udpData.today_traffic_out || 0);
                    lastStartTime = tcpData.last_start_time || udpData.last_start_time || '從未啟動';
                }

                const nodeIp = await fetchNodeIp(nodeName);
                const ip = tcpData.remote_port || udpData.remote_port 
                    ? `${nodeIp}:${tcpData.remote_port || udpData.remote_port}` 
                    : 'N/A';

                const detailsHtml = `
                    <p><strong>代理名稱:</strong> ${proxyName}</p>
                    <p><strong>節點名稱:</strong> ${nodeName}</p>
                    <p><strong>協議:</strong> ${protocol}</p>
                    <p><strong>狀態:</strong> ${statusText}</p>
                    <p><strong>當前連線數:</strong> ${totalConnections}</p>
                    <p><strong>上次啟動時間:</strong> ${lastStartTime}</p>
                    <p><strong>今日流量:</strong> 入網 ${formatTraffic(totalTrafficIn)} / 出網 ${formatTraffic(totalTrafficOut)}</p>
                    <p><strong>IP:</strong> ${ip}</p>
                    <canvas id="trafficChart" width="300" height="300"></canvas> <!-- Add canvas for pie chart -->
                `;

                if (!popupElement) {
                    popupElement = document.createElement('div');
                    popupElement.className = 'popup';
                    document.body.appendChild(popupElement);
                }

                popupElement.innerHTML = detailsHtml;
                popupElement.style.display = 'block';

                // Render the pie chart
                const ctx = document.getElementById('trafficChart').getContext('2d');
                const totalTraffic = totalTrafficIn + totalTrafficOut;
                const chartData = totalTrafficIn === 0 && totalTrafficOut === 0
                    ? {
                        labels: ['無數據/未使用'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#808080'], // Gray for "未使用"
                        }]
                    }
                    : {
                        labels: [
                            `入網流量 (${((totalTrafficIn / totalTraffic) * 100).toFixed(2)}%)`,
                            `出網流量 (${((totalTrafficOut / totalTraffic) * 100).toFixed(2)}%)`
                        ],
                        datasets: [{
                            data: [totalTrafficIn, totalTrafficOut],
                            backgroundColor: ['#0000FF', '#00FF00'], // Blue for inbound, green for outbound
                        }]
                    };

                new Chart(ctx, {
                    type: 'pie',
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        return `${formatTraffic(value)}`;
                                    }
                                }
                            }
                        },
                    }
                });

                // Calculate popup position
                const popupWidth = 300; // Approximate width of the popup
                let leftPosition = event.pageX;
                const screenWidth = window.innerWidth;

                // Adjust if the popup exceeds the right edge
                if (leftPosition + popupWidth > screenWidth) {
                    leftPosition = screenWidth - popupWidth - 35; // Add some padding
                }

                // Adjust if the popup exceeds the left edge
                if (leftPosition < 10) {
                    leftPosition = 10; // Add some padding
                }

                popupElement.style.left = `${leftPosition}px`;
                popupElement.style.top = `${event.pageY}px`;

                const closePopup = () => {
                    popupElement.style.display = 'none';
                    document.removeEventListener('click', closePopup);
                };

                setTimeout(() => {
                    document.addEventListener('click', closePopup, { once: true });
                }, 0);
            };

            async function listTunnels() {
                if (isLoggedIn) {
                    const usernameValue = username.split('=')[1];
                    const passwordValue = password.split('=')[1];

                    const response = await fetch('https://taiwanfrp.ddns.net/list_tunnels', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username: usernameValue, password: passwordValue })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        tunnels = data.tunnels;

                        if (tunnels.length === 0) {
                            noTunnelMessage.style.display = 'block';
                            tunnelList.innerHTML = ''; // Clear any existing content
                        } else {
                            noTunnelMessage.style.display = 'none';
                            renderTunnels();
                        }
                    } else {
                        noTunnelMessage.style.display = 'block'; // Show message if fetch fails
                        tunnelList.innerHTML = ''; // Clear any existing content
                    }
                }
            }

            async function updateTunnelData() {
                if (isLoggedIn && tunnels.length > 0) {
                    const usernameValue = username.split('=')[1];
                    const passwordValue = password.split('=')[1];

                    const convertToReadableSize = (bytes) => {
                        if (bytes < 1024) {
                            return `${bytes.toFixed(2)} B`;
                        } else if (bytes < 1024 * 1024) {
                            return `${(bytes / 1024).toFixed(2)} KB`;
                        } else if (bytes < 1024 * 1024 * 1024) {
                            return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
                        } else {
                            return `${(bytes / (1024 * 1024 * 1024)).toFixed(2)} GB`;
                        }
                    };

                    for (const tunnel of tunnels) {
                        const tcpResponse = await fetch('https://taiwanfrp.ddns.net/check_tunnel', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ username: usernameValue, password: passwordValue, tunnelName: tunnel.name, protocol: 'tcp', nodeName: tunnel.node })
                        });

                        const udpResponse = await fetch('https://taiwanfrp.ddns.net/check_tunnel', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ username: usernameValue, password: passwordValue, tunnelName: tunnel.name, protocol: 'udp', nodeName: tunnel.node })
                        });

                        const tcpData = tcpResponse.ok ? await tcpResponse.json() : { status: 'offline' };
                        const udpData = udpResponse.ok ? await udpResponse.json() : { status: 'offline' };

                        const tunnelRow = document.querySelector(`#tunnel-${tunnel.name}`);
                        if (tunnelRow) {
                            tunnelRow.querySelector('.tcp-status').innerHTML = `
                                <div class="tunnel-status ${tcpData.status === 'online' ? 'tunnel-status-online' : 'tunnel-status-offline'}">
                                    <span class="tunnel-status-icon"></span>
                                    ${tcpData.status === 'online' ? '在線' : '離線'}
                                </div>
                            `;
                            tunnelRow.querySelector('.tcp-conns').textContent = tcpData.cur_conns || 0;
                            tunnelRow.querySelector('.tcp-last-start').textContent = tcpData.last_start_time || '從未啟動';
                            tunnelRow.querySelector('.tcp-traffic').textContent = `入網 ${convertToReadableSize(tcpData.today_traffic_in || 0)} / 出網 ${convertToReadableSize(tcpData.today_traffic_out || 0)}`;

                            tunnelRow.querySelector('.udp-status').innerHTML = `
                                <div class="tunnel-status ${udpData.status === 'online' ? 'tunnel-status-online' : 'tunnel-status-offline'}">
                                    <span class="tunnel-status-icon"></span>
                                    ${udpData.status === 'online' ? '在線' : '離線'}
                                </div>
                            `;
                            tunnelRow.querySelector('.udp-conns').textContent = udpData.cur_conns || 0;
                            tunnelRow.querySelector('.udp-last-start').textContent = udpData.last_start_time || '從未啟動';
                            tunnelRow.querySelector('.udp-traffic').textContent = `入網 ${convertToReadableSize(udpData.today_traffic_in || 0)} / 出網 ${convertToReadableSize(udpData.today_traffic_out || 0)}`;
                        }
                    }
                }
            }

            function renderTunnels() {
                if (tunnels.length === 0) {
                    noTunnelMessage.style.display = 'block';
                    tunnelList.innerHTML = ''; // Clear any existing content
                    return;
                }
                noTunnelMessage.style.display = 'none';
                tunnelList.innerHTML = `
                    <div class="tunnel-table-container">
                        <table class="tunnel-table">
                            <thead>
                                <tr>
                                    <th>代理名稱</th>
                                    <th>節點名稱</th>
                                    <th>TCP 狀態</th>
                                    <th>TCP 連線數</th>
                                    <th>TCP 上次啟動時間</th>
                                    <th>TCP 今日流量</th>
                                    <th>UDP 狀態</th>
                                    <th>UDP 連線數</th>
                                    <th>UDP 上次啟動時間</th>
                                    <th>UDP 今日流量</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tunnels.map(tunnel => `
                                    <tr id="tunnel-${tunnel.name}">
                                        <td>${tunnel.name}</td>
                                        <td>${tunnel.node}</td>
                                        <td class="tcp-status"></td>
                                        <td class="tcp-conns"></td>
                                        <td class="tcp-last-start"></td>
                                        <td class="tcp-traffic"></td>
                                        <td class="udp-status"></td>
                                        <td class="udp-conns"></td>
                                        <td class="udp-last-start"></td>
                                        <td class="udp-traffic"></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                updateTunnelData();
            }

            if (isLoggedIn) {
                const usernameValue = username.split('=')[1];
                document.getElementById('current-username').textContent = `歡迎: ${usernameValue} 回來！以下是你的資訊！`;

                loginButton.style.display = 'none';
                registerButton.style.display = 'none';
                logoutButton.style.display = 'inline';
                deleteAccountButton.style.display = 'inline';
                editTunnelButton.style.display = 'inline';
                tunnelListSection.style.display = 'block';

                await renderRunidTree();
                await checkDiscordStatus();
                setInterval(renderRunidTree, 10000); // Refresh every 10 seconds
            } else {
                loginButton.style.display = 'inline';
                registerButton.style.display = 'inline';
                logoutButton.style.display = 'none';
                deleteAccountButton.style.display = 'none';
                editTunnelButton.style.display = 'none';
                tunnelListSection.style.display = 'none';

                const promoSection = document.createElement('section');
                promoSection.className = 'promo-section';
                promoSection.innerHTML = `
                    <h2>歡迎來到 TAIWANFRP官網</h2>
                    <p>註冊或登入帳號，享受免費的內網穿透服務，立刻架設Minecraft伺服器在自己的電腦上。</p>
                    <div class="promo-buttons">
                        <a href="reg.html">註冊</a>
                        <a href="login.html">登入</a>
                    </div>
                `;
                document.body.insertBefore(promoSection, document.getElementById('server-status-section'));
            }

            logoutButton.addEventListener('click', function() {
                confirmLogout();
            });

            deleteAccountButton.addEventListener('click', function() {
                confirmDeleteAccount();
            });

            async function loadNodes() {
                const response = await fetch('https://taiwanfrp.ddns.net/nodes.json');
                if (response.ok) {
                    const data = await response.json();
                    nodes = data.nodes;
                    renderServerStatus();
                }
            }

            function showServerPopup(serverName, info, event) {
                let popupElement = document.querySelector('.popup');
                if (!popupElement) {
                    popupElement = document.createElement('div');
                    popupElement.className = 'popup';
                    document.body.appendChild(popupElement);
                }
                const totalTraffic = (info.totalTrafficIn || 0) + (info.totalTrafficOut || 0);
                const detailsHtml = `
                    <p><strong>伺服器名稱:</strong> ${serverName}</p>
                    <p><strong>在線客戶端:</strong> ${info.clientCounts}</p>
                    <p><strong>建立連接:</strong> ${info.curConns}</p>
                    <p><strong>TCP 代理數:</strong> ${info.tcp}</p>
                    <p><strong>UDP 代理數:</strong> ${info.udp}</p>
                    <p><strong>今日流量:</strong> 入網 ${formatTraffic(info.totalTrafficIn)} / 出網 ${formatTraffic(info.totalTrafficOut)}</p>
                    <p><strong>忙碌程度:</strong> <span class="server-level ${info.level && info.level.includes('最流暢') ? 'level-best' : info.level && info.level.includes('普通') ? 'level-normal' : info.level && info.level.includes('最忙碌') ? 'level-busy' : ''}">${info.level || '-'}</span></p>
                    <canvas id="serverTrafficChart" width="300" height="300"></canvas>
                `;
                popupElement.innerHTML = detailsHtml;
                popupElement.style.display = 'block';
                // Pie chart
                const ctx = document.getElementById('serverTrafficChart').getContext('2d');
                const chartData = (info.totalTrafficIn === 0 && info.totalTrafficOut === 0)
                    ? {
                        labels: ['無數據/未使用'],
                        datasets: [{ data: [1], backgroundColor: ['#808080'] }]
                    }
                    : {
                        labels: [
                            `入網流量 (${((info.totalTrafficIn / totalTraffic) * 100).toFixed(2)}%)`,
                            `出網流量 (${((info.totalTrafficOut / totalTraffic) * 100).toFixed(2)}%)`
                        ],
                        datasets: [{
                            data: [info.totalTrafficIn, info.totalTrafficOut],
                            backgroundColor: ['#0000FF', '#00FF00']
                        }]
                    };
                new Chart(ctx, {
                    type: 'pie',
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        return `${formatTraffic(value)}`;
                                    }
                                }
                            }
                        }
                    }
                });
                // Calculate popup position (use event if available, fallback to center)
                const popupWidth = 300;
                let leftPosition = event && event.pageX ? event.pageX : window.innerWidth / 2 - popupWidth / 2;
                const screenWidth = window.innerWidth;
                if (leftPosition + popupWidth > screenWidth) {
                    leftPosition = screenWidth - popupWidth - 35;
                }
                if (leftPosition < 10) {
                    leftPosition = 10;
                }
                popupElement.style.left = `${leftPosition}px`;
                popupElement.style.top = `${event && event.pageY ? event.pageY : `calc(50% - 150px)`}px`;
                setTimeout(() => {
                    document.addEventListener('click', function closePopup(e) {
                        if (!popupElement.contains(e.target)) {
                            popupElement.style.display = 'none';
                            document.removeEventListener('click', closePopup);
                        }
                    }, { once: true });
                }, 0);
            }

            function renderServerStatus() {
                const serverStatusList = document.getElementById('server-status-list');
                serverStatusList.innerHTML = '';
                for (const node of nodes) {
                    const statusItem = `
                        <tr data-server-name="${node.name}">
                            <td>${node.name}</td>
                            <td class="server-status-offline">
                                <span class="server-status-icon"></span>
                                <span class="server-status-text">離線</span>
                            </td>
                            <td class="server-level">-</td>
                        </tr>
                    `;
                    serverStatusList.innerHTML += statusItem;
                }
                // 新增點擊事件
                serverStatusList.querySelectorAll('tr').forEach(row => {
                    row.addEventListener('click', async function(e) {
                        const serverName = row.getAttribute('data-server-name');
                        // 取得server info
                        try {
                            const resp = await fetch(`https://taiwanfrp.ddns.net/api/get_one_serverinfo?nodeName=${encodeURIComponent(serverName)}`);
                            if (resp.ok) {
                                const info = await resp.json();
                                showServerPopup(serverName, info, e); // 傳入 event
                            }
                        } catch {}
                    });
                });
            }

            async function checkServerStatus() {
                const serverStatusList = document.getElementById('server-status-list');
                const rows = serverStatusList.querySelectorAll('tr');
                for (const row of rows) {
                    const serverName = row.querySelector('td:first-child').textContent;
                    const statusCell = row.querySelector('td:nth-child(2)');
                    const levelCell = row.querySelector('td:nth-child(3)');
                    // 狀態
                    const statusResponse = await fetch('https://taiwanfrp.ddns.net/check_frps_status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ serverName })
                    });
                    const statusText = statusResponse.ok ? await statusResponse.text() : '離線';
                    const statusClass = statusText === '在線' ? 'server-status-online' : 'server-status-offline';
                    statusCell.innerHTML = `
                        <span class="server-status-icon"></span>
                        <span class="server-status-text">${statusText}</span>
                    `;
                    statusCell.className = statusClass;
                    // 忙碌程度
                    try {
                        const infoResp = await fetch(`https://taiwanfrp.ddns.net/api/get_one_serverinfo?nodeName=${encodeURIComponent(serverName)}`);
                        if (infoResp.ok) {
                            const info = await infoResp.json();
                            let levelClass = '';
                            let levelText = info.level || '-';
                            if (levelText.includes('最流暢')) {
                                levelClass = 'level-best';
                            } else if (levelText.includes('普通')) {
                                levelClass = 'level-normal';
                            } else if (levelText.includes('最忙碌')) {
                                levelClass = 'level-busy';
                            }
                            levelCell.textContent = levelText;
                            levelCell.className = `server-level ${levelClass}`;
                        } else {
                            levelCell.textContent = '-';
                            levelCell.className = 'server-level';
                        }
                    } catch {
                        levelCell.textContent = '-';
                        levelCell.className = 'server-level';
                    }
                }
            }

            await loadNodes();
            checkServerStatus();
            setInterval(checkServerStatus, 10000); // Update every 10 seconds

            async function checkDiscordStatus() {
                const username = document.cookie.split('; ').find(row => row.startsWith('username=')).split('=')[1];
                const password = document.cookie.split('; ').find(row => row.startsWith('password=')).split('=')[1];

                const response = await fetch('https://taiwanfrp.ddns.net/verify_discord_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (!data.inGroup) {
                        document.getElementById('discord-status').style.display = 'block';
                    }
                } else {
                    console.error('Failed to verify Discord status');
                }
            }

        });

        async function checkExpirationStatus() {
            const username = document.cookie.split('; ').find(row => row.startsWith('username=')).split('=')[1];
            const password = document.cookie.split('; ').find(row => row.startsWith('password=')).split('=')[1];

            const response = await fetch('https://taiwanfrp.ddns.net/check_expiration', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.expired) {
                    document.getElementById('account-expired-status').style.display = 'block';
                }
            } else {
                console.error('Failed to check expiration status');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkExpirationStatus();
        });

        function showMessage(message, success = false, callback = null) {
            const messageBox = document.getElementById('message-box');
            const overlay = document.getElementById('overlay');
            messageBox.innerHTML = `<p>${message}</p>`;
            if (success) {
                messageBox.innerHTML += `<button onclick="window.location.href='index.html'">確定</button>`;
            } else {
                messageBox.innerHTML += `<button onclick="hideMessage()">取消</button>`;
            }
            if (callback) {
                messageBox.innerHTML += `<button onclick="${callback}">確定</button>`;
            }
            messageBox.style.display = 'block';
            overlay.style.display = 'block';
            document.addEventListener('keydown', handleEnterKey);
        }

        function hideMessage() {
            document.getElementById('message-box').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            document.removeEventListener('keydown', handleEnterKey);
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                const button = document.querySelector('.message-box button');
                if (button) {
                    button.click();
                }
            }
        }

        function confirmLogout() {
            const messageBox = document.getElementById('message-box');
            const overlay = document.getElementById('overlay');
            messageBox.innerHTML = `
                <p>確定要登出嗎？</p>
                <div style="margin-top: 10px;">
                    <button onclick="hideMessage()" style="margin-right: 20px;">取消</button>
                    <button onclick="logout()">確定</button>
                </div>
            `;
            messageBox.style.display = 'block';
            overlay.style.display = 'block';
            document.addEventListener('keydown', handleEnterKey);
        }

        function confirmDeleteAccount() {
            const messageBox = document.getElementById('message-box');
            const overlay = document.getElementById('overlay');
            messageBox.innerHTML = `
                <p>確定要註銷帳號嗎？這將刪除所有代理和端口，無法復原。</p>                <div style="margin-top: 10px;">
                    <label for="delete-password">請輸入密碼確認:</label>
                </div>
                <div style="margin-top: 10px;">
                    <input type="password" id="delete-password" name="delete-password" required>
                </div>
                <div style="margin-top: 10px;">
                    <button onclick="hideMessage()" style="margin-right: 20px;">取消</button>
                    <button onclick="deleteAccount()">確定</button>
                </div>
            `;
            messageBox.style.display = 'block';
            overlay.style.display = 'block';
            document.addEventListener('keydown', handleEnterKey);
        }

        async function logout() {
            const response = await fetch('https://taiwanfrp.ddns.net/logout', { method: 'POST' });
            if (response.ok) {
                document.cookie = 'username=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
                document.cookie = 'password=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
                window.location.href = 'index.html';
            } else {
                showMessage('登出失敗');
            }
        }

        async function deleteAccount() {
            const password = document.getElementById('delete-password').value;
            const username = document.cookie.split('; ').find(row => row.startsWith('username=')).split('=')[1];
            const response = await fetch('https://taiwanfrp.ddns.net/delete_account', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                showMessage('帳號已成功註銷', true);
                document.cookie = 'username=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
                document.cookie = 'password=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            } else {
                showMessage('註銷失敗: ' + await response.text());
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const hamburger = document.getElementById('hamburger-menu');
            const nav = document.getElementById('main-nav');
            hamburger.addEventListener('click', function(e) {
                e.stopPropagation();
                nav.classList.toggle('open');
            });
            // 點擊外部自動收起
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 900 && nav.classList.contains('open')) {
                    if (!nav.contains(e.target) && e.target !== hamburger) {
                        nav.classList.remove('open');
                    }
                }
            });
            // 視窗縮放時自動收起
            window.addEventListener('resize', function() {
                if (window.innerWidth > 900) {
                    nav.classList.remove('open');
                }
            });
        });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        // Fetch TaiwanFRP service status
        async function fetchTaiwanFRPStatus() {
            try {
                const response = await fetch('https://taiwanfrp.ddns.net/api/aggregate_serverinfo');
                if (!response.ok) {
                    console.error('Failed to fetch TaiwanFRP status');
                    return null;
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching TaiwanFRP status:', error);
                return null;
            }
        }

        // Render TaiwanFRP service status
        async function renderTaiwanFRPStatus() {
            const statusData = await fetchTaiwanFRPStatus();
            if (!statusData) return;

            const statusHtml = `
                <div class="server-status-container">
                    <h3>TAIWANFRP 總量統計</h3>
                    <p><strong>在線客戶端總量:</strong> ${statusData.total_client_counts}</p>
                    <p><strong>建立連接總量:</strong> ${statusData.total_cur_conns}</p>
                    <p><strong>今日總流量:</strong> 入網 ${formatTraffic(statusData.total_traffic_in)} / 出網 ${formatTraffic(statusData.total_traffic_out)}</p>
                    <p><strong>TCP 代理總數:</strong> ${statusData.total_tcp}</p>
                    <p><strong>UDP 代理總數:</strong> ${statusData.total_udp}</p>
                </div>
            `;

            const serverStatusDiv = document.getElementById('taiwanfrp-status');
            if (serverStatusDiv) {
                serverStatusDiv.innerHTML = statusHtml;
            }
        }

        // Call the render function and set interval for updates
        renderTaiwanFRPStatus();
        setInterval(renderTaiwanFRPStatus, 10000); // Update every 5 seconds
    });
</script>

</head>
<body>

    <!-- Header -->
    <header>
        <h1>TAIWANFRP</h1>
        <nav>
            <!-- Hamburger menu button (mobile only) -->
            <button id="hamburger-menu" aria-label="開啟選單" style="display:none; background:none; border:none; font-size:32px; cursor:pointer; position:absolute; left:6px; top:16px; z-index:2000; border: none !important;">
              <span style="display:block; width:28px; height:22px; position:relative;">
                <span style="position:absolute; left:0; top:0; width:100%; height:4px; background:#000; border-radius:2px;"></span>
                <span style="position:absolute; left:0; top:9px; width:100%; height:4px; background:#000; border-radius:2px;"></span>
                <span style="position:absolute; left:0; top:18px; width:100%; height:4px; background:#000; border-radius:2px;"></span>
              </span>
            </button>
            <ul id="main-nav" style="transition: max-height 0.4s cubic-bezier(0.4,0,0.2,1); overflow:hidden;">
                <li><a href="#home">這是什麼？</a></li>
                <li><a href="#services">服務介紹</a></li>
                <li><a href="#download">軟體下載</a></li>
                <li><a href="#contact">聯絡我們</a></li>
                <li><a href="howto.html">教學影片</a></li>
                <li><a href="/docs">TaiwanFRP文檔</a></li>
            </ul>
        </nav>
        <div class="auth-buttons">
            <a href="reg.html" id="register-button">註冊</a>
            <a href="login.html" id="login-button">登入</a>
            <a href="editini.html" id="edit-tunnel-button" style="display: none;">編輯我的代理</a>
            <a href="#" id="logout-button" style="display: none;">登出</a>
            <button id="delete-account-button" style="display: none;">註銷帳號</button>
        </div>
    </header>

                <!-- Server Status Section -->
                <section id="server-status-section" style="text-align: center; background-color: rgba(255, 255, 255, 0.7);">
                    <h2 style="color: #000;">內網穿透伺服器狀態</h2>
                    <div class="server-status-table-container">
                        <table class="server-status-table">
                            <thead>
                                <tr>
                                    <th>伺服器名稱</th>
                                    <th>狀態</th>
                                    <th>忙碌程度</th>
                                </tr>
                            </thead>
                            <tbody id="server-status-list">
                                <!-- Server status will be populated here -->
                            </tbody>
                            <div id="taiwanfrp-status" class="server-status-container">
                            <!-- TaiwanFRP service status will be dynamically loaded here -->
                            </div>
                            </table>
                            <a href="http://taiwanfrp.ddns.net:8000/whatmybestchooise.html" target="_blank" style="margin-left:10px;color:#007bff;text-decoration:underline;font-size:14px;vertical-align:middle;display:inline-block;margin-top:8px;">該選哪個？</a>
                    </div>
                </section>

    <!-- Tunnel List Section -->
    <section id="tunnel-list-section" style="text-align: center; background-color: rgba(255, 255, 255, 0.7); display: none;">
        <h2 style="color: #000;">我的代理狀態</h2>
        <div id="discord-status" class="discord-status">
            偵測到未加入Discord，請及時加入，否則將無法啟動代理！
            <button onclick="window.open('https://discord.gg/ueGFVVHp85', '_blank')">加入Discord</button>
        </div>
        <div id="account-expired-status" class="discord-status">
            帳號已經到期，無法啟動代理！請聯絡TaiwanFRP
            <button onclick="window.open('https://discord.gg/PcWgJf3txz', '_blank')">聯絡我們</button>
        </div>
        <p id="current-username" style="color: #000;"></p>
        <div id="tunnel-list" style="color: #000;"></div>
        <p id="no-tunnel-message" class="no-tunnel-message" style="display: none;">當前還沒有代理，點擊右上角 "編輯我的代理" 來新增代理。</p>
    </section>





    <!-- Home Section -->
    <section id="home" style="text-align: center; background-color: rgba(255, 255, 255, 0.7);">
        <h2 style="color: #000;">TAIWANFRP</h2>
        <h2 style="color: #000;">免費內網穿透服務</h2>
        <div style="max-width: 600px; margin: 0 auto; text-align: left; background: none;">
            <h3 style="color: #1fb032; margin-top: 24px;">TaiwanFRP 運作原理</h3>
            <ol style="color: #000; font-size: 1.08em; line-height: 2; padding-left: 20px;">
                <li>你的電腦（TaiwanFRP客戶端）會連線到 TaiwanFRP 伺服器（公網節點），建立安全通道。</li>
                <li>其他使用者只需連線 TaiwanFRP 伺服器你設定的指定端口(遠程端口)，TaiwanFRP伺服器就會將該端口的流量傳到你電腦上的TaiwanFRP客戶端。</li>
                <li>接下來，你的伺服器就跟你的使用者成功建立連線了！</li>
                <li>無需設定你家路由器或電腦上的防火牆，任何網路環境都能輕鬆架設伺服器。</li>
            </ol>
            <div style="margin-top: 18px;">
                <span style="color: #000; font-weight: bold;">想了解詳細設定流程？</span>
                <a href="howto.html" style="color: #1fb032; text-decoration: underline; font-weight: bold;">教學影片</a>
            </div>
        </div>
    </section>


    <!-- Services Section -->
    <section id="services" style="text-align: center; background-color: rgba(255, 255, 255, 0.7);">
        <h2 style="color: #000;">服務特色</h2>
        <ul style="color: #000; text-align: left; display: inline-block; margin: 0 auto; font-size: 1.1em; line-height: 2; padding-left: 0;">
            <li>無需設定路由器，簡化所有操作。</li>
            <li>只需註冊帳號並創建代理，即可架設 Minecraft 或其他 TCP/UDP 伺服器。</li>
            <li>客戶端無須安裝任何軟體，效果如同設定好路由器。</li>
            <li>支援 4G/5G 行動網路及台灣各大寬頻，無需擔心防火牆。</li>
            <li>免費服務，專為沒有公網 IP 的用戶設計。</li>
            <li>同時支援 TCP 與 UDP 流量轉發，確保伺服器穩定運行。</li>
            <li>你的伺服器，運行於你的電腦，安全無虞</li>
        </ul>
        <p style="color: #ff0000; font-weight: bold; margin-top: 16px;">注意：所有伺服器都運行在您的電腦上，我們僅提供內網穿透服務，協助公開您的本地伺服器。</p>
    </section>

    <!-- Software Download Section -->
    <section id="download" style="text-align: center; background-color: rgba(255, 255, 255, 0.7); /* 白色背景透明度為0.7 */">
        <h2 style="color: #000;">軟體下載</h2>
        <p style="color: #000;">選擇您的作業系統下載對應的軟體版本。</p>
        <div class="download-buttons">
            <a href="https://taiwanfrp.ddns.net/windows/taiwanfrp.exe">Windows</a>
            <a href="https://taiwanfrp.ddns.net/linux/taiwanfrp">Linux(ARM)</a>
            <a href="https://taiwanfrp.ddns.net/linuxX86/taiwanfrp">Linux(x86_64)</a>
            <a href="https://taiwanfrp.ddns.net/macos/taiwanfrp">macOS(M1以上)</a>
            <a href="https://taiwanfrp.ddns.net/macosintel/taiwanfrp">macOS(英特爾晶片)</a>
        </div>
        <p style="color: #000;">Linux和macOS腳本下載完畢之後，請先cd到該目錄下執行 <code>chmod +x taiwanfrp</code>再執行<code>./taiwanfrp</code>。</p>
        <p style="color: rgb(255, 0, 0);">*軟體需搭配帳號使用，請先<a href="reg.html" style="color: rgb(106, 106, 234); text-decoration: underline;">註冊帳號</a>*</p>
    </section>


        <!-- 成為合作夥伴 -->
        <section id="download" style="text-align: center; background-color: rgba(255, 255, 255, 0.7); /* 白色背景透明度為0.7 */">
            <h2 style="color: #000;">成為TAIWANFRP合作夥伴</h2>
            <p style="color: #000;">將您的frp伺服器通過TAIWANFRP發揚光大！</p>
            <div class="download-buttons">
                <a href="partner.html">開始申請！</a>
            </div>
        </section>


    <!-- Contact Section -->
    <section id="contact" style="background-color: rgba(255, 255, 255, 0.7); /* 白色背景透明度為0.7 */">
        <h2>聯絡我們</h2>
        <p style="color: #000;">電子郵件: <a href="mailto:kiwi071294@gmail.com" style="color: #000;">kiwi071294@gmail.com</a></p>
        <p style="color: #000;">Discord 群組: <a href="https://discord.gg/83AFn92DbX" target="_blank" rel="noopener noreferrer" style="color: #000;" title="加入我們的Discord">加入我們的Discord</a></p>
    </section>

    <!-- Footer -->
    <footer style="background-color: rgba(255, 255, 255, 0.7); /* 白色背景透明度為0.7 */">
        powered by kiwi071294
        <button onclick="window.location.href='admin.html'" style="background: none; border: none; color: #ccc; cursor: pointer; font-size: 12px; display: block; margin-top: 10px;">管理員中心</button>
    </footer>

    <div id="message-box" class="message-box"></div>
    <div id="overlay" class="overlay"></div>
        <img src="img/terms.png" alt="隱私權圖標" id="privacy-icon" style="position: absolute; right: 24px; bottom: 80px; z-index: 9999; width: 56px; height: 56px; cursor: pointer; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); background: #fff; padding: 6px; transition: top 0.7s cubic-bezier(0.4,0,0.2,1), left 0.7s cubic-bezier(0.4,0,0.2,1);" onclick="window.location.href='/terms.html'" />

    <script>
    (function() {
        const icon = document.getElementById('privacy-icon');
        const iconWidth = 56; // px
        const iconHeight = 56; // px
        const marginRight = 24; // px
        const marginBottom = 80; // px
        function updateIconPosition() {
            const scrollY = window.scrollY || window.pageYOffset;
            const scrollX = window.scrollX || window.pageXOffset;
            const windowHeight = window.innerHeight;
            const windowWidth = window.innerWidth;
            // 計算不會超出螢幕右下角的位置
            let top = scrollY + windowHeight - iconHeight - marginBottom;
            let left = scrollX + windowWidth - iconWidth - marginRight;
            // 保證 top/left 不小於 0
            top = Math.max(top, 0);
            left = Math.max(left, 0);
            icon.style.top = top + 'px';
            icon.style.left = left + 'px';
        }
        // 設定初始 absolute 位置
        icon.style.position = 'absolute';
        icon.style.top = '0px';
        icon.style.left = '0px';
        window.addEventListener('scroll', updateIconPosition);
        window.addEventListener('resize', updateIconPosition);
        // 初始化
        updateIconPosition();
    })();
    </script>

    </body>
</html>
